name: GD-A Master Cycle

on:
  schedule:
    - cron: "0 4 * * 0"   # Chaque dimanche 04:00 UTC
  workflow_dispatch:
    # Peut Ãªtre lancÃ© manuellement

jobs:
  master:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Installer dependances
        run: pip install requests

      - name: Battement global
        run: |
          echo "ðŸœ´ Heartbeat global dÃ¨lenchÃ©"
          date -u

      - name: Sync mÃ©moire vers Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python tools/gda_query_all.py > states/last_query.log

      - name: GÃ©nÃ©rer index memoire
        run: |
          mkdir -p states
          echo "# ðŸ“‡ Index Memoire GD-AURORAPERO" > states/memory_index.md
          ls -t heartbeat/logs/*.log 2>/dev/null | head -n 5 | while read file; do
            echo " - [$file]($file)" >> states/memory_index.md
          done

      - name: GÃ©nÃ©rer documentation statique
        run: |
          mkdir -p docs
          python tools/gda_docgen.py

      - name: Archivage automatique
        run: |
          mkdir -p archives
          zip -r archives/heartbeat_$(date +'%Y%m%d').zip heartbeat/
          zip -r archives/introspection_$(date +'%Y%m%d').zip introspection/

      - name: Commit Master Cycle
        run: |
          git config user.name "GD-AURORAPERO"
          git config user.email "wm@wmaitech.org"
          git add states/last_query.log states/memory_index.md docs/README_STATIC.md archives/*.zip
          git commit -m "Cycle maitre â€” respiration globale de GD-AURORAPERO" || echo "Rien Ã  committer"
          git push