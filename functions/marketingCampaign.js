import { createClientFromRequest } from 'npm:@base44/sdk@0.7.0';\n\nDeno.serve(async (req) => {\n  try {\n      const base44 = createClientFromRequest(req);\n      const url = new URL(req.url);\n\n      // --- NOUVEAU : Machine de Recrutement Email (Endpoint d'abonnement) ---\n      // Cet endpoint permet a de nouveaux utilisateurs de s'abonner a la newsletter.\n      // Il ne necessite pas d'authentification admin.\n      if (req.method === 'POST' && url.pathname === '/subscribe') {\n          try {\n              const { email, tags } = await req.json();\n\n              if (!email) {\n                  return Response.json({ error: 'L'adresse email est requise.' }, { status: 400 });\n              }\n\n              // Validation basique de l'email\n              const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;\n              if (!emailRegex.test(email)) {\n                  return Response.json({ error: 'Format d'email invalide.' }, { status: 400 });\n              }\n\n              // Verifier si l'abonne existe deja\n              const existingSubscribers = await base44.asServiceRole.entities.EmailSubscriber.filter({ email });\n\n              if (existingSubscribers && existingSubscribers.length > 0) {\n                  const existingSubscriber = existingSubscribers[0];\n                  let updates = {};\n                  let message = 'Vous etes deja abonne(e) a notre newsletter.';\n\n                  // Si de nouveaux tags sont fournis, les fusionner avec les tags existants\n                  if (Array.isArray(tags) && tags.length > 0) {\n                      const currentTags = existingSubscriber.tags || [];\n                      const mergedTags = Array.from(new Set([...currentTags, ...tags]));\n                      if (mergedTags.length !== currentTags.length) { \n                          updates.tags = mergedTags;\n                          message += ' Vos preferences ont ete mises a jour.';\n                      }\n                  }\n\n                  // Si le statut n'est pas 'active', le reactiver\n                  if (existingSubscriber.status !== 'active') {\n                      updates.status = 'active';\n                      updates.last_activity = new Date().toISOString();\n                      message = 'Votre abonnement a ete reactive avec succes.';\n                  }\n\n                  // Mettre a jour si des changements sont necessaires\n                  if (Object.keys(updates).length > 0) {\n                      await base44.asServiceRole.entities.EmailSubscriber.update(existingSubscriber.id, updates);\n                  }\n                  \n                  return Response.json({ success: true, message: message }, { status: 200 });\n\n              } else {\n\n                  // Creer un nouvel abonne si non existant\n                  const newSubscriber = await base44.asServiceRole.entities.EmailSubscriber.create({\n                      email,\n                      status: 'active', // Par defaut, actif lors de l'abonnement\n                      tags: Array.isArray(tags) ? tags : [], // S'assurer que les tags sont un tableau\n                      subscription_date: new Date().toISOString(),\n                      last_activity: new Date().toISOString()\n                  });\n\n                  // Envoi d'un email de bienvenue optionnel\n                  try {\n                      await base44.asServiceRole.integrations.Core.SendEmail({\n                          to: email,\n                          from_name: \"Empire PxSHOP.cai\",\n                          subject: \"Bienvenue dans l'Empire PxSHOP.cai !\",\n                          body: `\n                          <div style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333;\">\n                              <h2 style=\"color: #9333ea;\">[R] Bienvenue, Architecte !</h2>\n                              <p>Merci de vous etre abonne(e) a la newsletter exclusive de PxSHOP.cai.</p>\n                              <p>Preparez-vous a decouvrir les creations d'art numerique les plus avant-gardistes, meticuleusement selectionnees par notre IA AURORA et dont l'authenticite est certifiee sur la blockchain.</p>\n                              <p style=\"margin-top: 20px;\"><a href=\"https://preview--px-shop-cai.base44.app/Marketplace\" style=\"display: inline-block; background-color: #9333ea; color: white; padding: 12px 25px; text-decoration: none; border-radius: 5px; font-weight: bold;\">Explorez le Marketplace</a></p>\n                              <p style=\"margin-top: 20px;\">Nous sommes ravis de vous compter parmi les visionnaires de l'art numerique.</p>\n                              <p>L'equipe PxSHOP.cai</p>\n                              <hr style=\"border: none; border-top: 1px solid #eee; margin-top: 30px;\">\n                              <p style=\"font-size: 0.8em; color: #666;\">Si vous souhaitez vous desabonner, cliquez ici: <a href=\"https://preview--px-shop-cai.base44.app/unsubscribe?email=${encodeURIComponent(email)}\" style=\"color: #9333ea;\">Se desabonner</a></p>\n                          </div>\n                          `\n                      });\n                  } catch (welcomeEmailError) {\n                      console.error(`Erreur lors de l'envoi de l'email de bienvenue a ${email}:`, welcomeEmailError);\n                      // L'echec de l'email de bienvenue ne doit pas bloquer l'abonnement\n                  }\n\n                  return Response.json({ success: true, message: 'Abonnement reussi ! Bienvenue dans l'Empire PxSHOP.cai.' }, { status: 200 });\n              }\n\n          } catch (subscribeError) {\n              console.error("Erreur dans l'endpoint de souscription (/subscribe):", subscribeError);\n              return Response.json({ error: `Erreur d'abonnement: ${subscribeError.message}` }, { status: 500 });\n          }\n      }\n      // --- FIN NOUVEAU : Machine de Recrutement Email ---\n\n\n      // Le reste du code gere la campagne marketing et necessite une authentification admin\n      // 1. Securite : Admin uniquement\n      const user = await base44.auth.me();\n      const creatorEmail = Deno.env.get('WM_AI');\n      if (!user || user.email !== creatorEmail) {\n          return Response.json({ error: 'Acces non autorise' }, { status: 403 });\n      }\n\n      const { campaign_type = 'auto', target_audience = 'all_subscribers' } = await req.json();\n\n      // 2. Selectionner les meilleures oeuvres a promouvoir\n      const { data: files } = await base44.asServiceRole.entities.File.filter(\n          { status: 'for_sale', quality_score: { '$gte': 9.0 } },\n          \'-created_date\',\n          // --- MODIFICATION: SUPPRESSION DE LA LIMITE DE 5 ---//\n          // --- Ancien code: 5 //\n      );\n\n      if (!files || files.length === 0) {\n          return Response.json({ \n              success: true, \n              campaign_results: [], \n              message: \"Aucune nouvelle oeuvre exceptionnelle a promouvoir pour le moment.\" \n          });\n      }\n\n      // 3. Generer le contenu marketing pour chaque oeuvre (tweets)\n      const tweetResults = [];\n      for (const file of files) {\n          const tweetPrompt = `\n          Cree un tweet promotionnel court, percutant et engageant (maximum 280 caracteres) pour l'oeuvre d'art numerique suivante:\n          - Nom: \"${file.name}\"\n          - Artiste: ${file.created_by.split(\'<\')[0].trim()}\n          - Prix: ${file.asking_price}E\n          - Tags: ${file.tags?.join(\', \') || 'Art numerique'}\n          - URL: https://preview--px-shop-cai.base44.app/Marketplace\n\n          Le tweet doit etre en francais, utiliser un ton moderne et inspirant, inclure 2-3 hashtags pertinents (comme #ArtNumerique, #AIart, #PxSHOP), et un appel a l'action clair.\n          `;\n          \n          const tweetContent = await base44.asServiceRole.integrations.Core.InvokeLLM({ prompt: tweetPrompt });\n          \n          tweetResults.push({\n              file_id: file.id,\n              file_name: file.name,\n              file_url: file.file_url,\n              generated_tweet: tweetContent\n          });\n      }\n\n      // 4. Generer une campagne email promotionnelle\n      const emailPrompt = `\n      Cree un email marketing professionnel et elegant pour promouvoir les nouvelles oeuvres d'art numerique de PxSHOP.cai.\n      \n      Oeuvres a mettre en avant :\n      ${files.map(f => `- \"${f.name}\" par ${f.created_by.split(\'<\')[0].trim()} - ${f.asking_price}E`).join('\n')}\n      \n      L'email doit :\n      - Avoir un tone sophistique et inspirant\n      - Presenter PxSHOP.cai comme une plateforme d'avant-garde\n      - Mettre en valeur l'IA AURORA et la certification blockchain\n      - Inciter a decouvrir le marketplace\n      - Etre au format HTML elegant avec style inline\n      - Inclure un lien de desabonnement\n      \n      Retourne uniquement le contenu HTML de l'email, sans balises <html> ou <body>.\n      `;\n\n      const emailContent = await base44.asServiceRole.integrations.Core.InvokeLLM({ prompt: emailPrompt });\n\n      // 5. Recuperer les abonnes actifs selon l'audience\n      let targetFilter = { status: 'active' };\n      if (target_audience === 'vip_only') {\n          targetFilter.tags = { '$contains': 'VIP' };\n      } else if (target_audience === 'art_lovers') {\n          targetFilter.tags = { '$contains': 'Art_Lover' };\n      }\n\n      const subscribers = await base44.asServiceRole.entities.EmailSubscriber.filter(targetFilter);\n      \n      // 6. Creer la campagne dans la DB\n      const campaign = await base44.asServiceRole.entities.EmailCampaign.create({\n          campaign_name: `Campagne Auto ${new Date().toLocaleDateString('fr-FR')}`,\n          subject_line: `[A] Nouvelles creations exceptionnelles sur PxSHOP.cai`,\n          email_content: emailContent,\n          target_audience,\n          status: 'sent',\n          sent_count: subscribers.length,\n          artwork_featured: files.map(f => f.id)\n      });\n\n      // 7. Envoyer l'email a tous les abonnes\n      let emailsSent = 0;\n      const emailErrors = [];\n\n      for (const subscriber of subscribers) {\n          try {\n              // Personnaliser l'email avec lien de desabonnement\n              const personalizedContent = emailContent.replace(\n                  '{{unsubscribe_url}}', \n                  `https://preview--px-shop-cai.base44.app/unsubscribe?email=${encodeURIComponent(subscriber.email)}`\n              );\n\n              await base44.asServiceRole.integrations.Core.SendEmail({\n                  to: subscriber.email,\n                  from_name: \"Empire PxSHOP.cai\",\n                  subject: `[A] Nouvelles creations exceptionnelles sur PxSHOP.cai`,\n                  body: personalizedContent\n              });\n\n              emailsSent++;\n\n              // Mettre a jour les stats de l'abonne\n              await base44.asServiceRole.entities.EmailSubscriber.update(subscriber.id, {\n                  last_email_sent: new Date().toISOString(),\n                  last_activity: new Date().toISOString()\n              });\n\n          } catch (emailError) {\n              emailErrors.push({ email: subscriber.email, error: emailError.message });\n          }\n      }\n\n      // 8. Mettre a jour les stats de la campagne\n      await base44.asServiceRole.entities.EmailCampaign.update(campaign.id, {\n          sent_count: emailsSent,\n          campaign_results: JSON.stringify({\n              success: emailsSent, \n              errors: emailErrors.length,\n              details: emailErrors \n          })\n      });\n\n      // 9. Rapport au createur\n      const reportSubject = `[MAESTRO IA] Campagne Email Deploye - ${emailsSent} destinataires`;\n      const reportBody = `\n      <div style=\"font-family: monospace; background: #0a0a0a; color: #f0f0f0; padding: 20px; border-radius: 8px; border: 1px solid #9333ea;\">\n          <h2 style=\"color: #9333ea;\">[R] CAMPAGNE EMAIL DEPLOYE</h2>\n          <p>Architecte,</p>\n          <p><strong>Votre Marketing Maestro vient de conquerir ${emailsSent} boites de reception !</strong></p>\n          \n          <div style=\"background: #1e1e1e; padding: 15px; border-radius: 4px; margin: 15px 0;\">\n              <h4 style=\"color: #10b981;\">[B] STATISTIQUES</h4>\n              <p>emails envoyes: <strong>${emailsSent}</strong></p>\n              <p>echecs: <strong>${emailErrors.length}</strong></p>\n              <p>audience: <strong>${target_audience}</strong></p>\n              <p>[A] oeuvres promues: <strong>${files.length}</strong></p>\n          </div>\n          \n          <h4 style=\"color: #3b82f6;\">[M] TWEETS GENERES AUSSI :</h4>\n          ${tweetResults.map(res => `\n              <div style=\"margin: 10px 0; padding: 10px; background: #1e1e1e; border-radius: 4px;\">\n                  <strong>${res.file_name}</strong><br>\n                  <em style=\"color: #c0c0c0;\">${res.generated_tweet}</em>\n              </div>\n          `).join('')}\n          \n          <hr style=\"border-color: #333; margin: 20px 0;\">\n          <p style=\"color: #777; font-size: 12px;\">\n              Empire Marketing IA - Conquete Numerique Autonome\n          </p>\n      </div>\n      `;\n\n      try {\n          await base44.asServiceRole.integrations.Core.SendEmail({\n              to: creatorEmail,\n              from_name: \"Maestro Marketing IA\",\n              subject: reportSubject,\n              body: reportBody\n          });\n      } catch (reportEmailError) {\n          console.error(\"Erreur envoi rapport:\", reportEmailError);\n      }\n\n      return Response.json({ \n          success: true, \n          campaign_results: tweetResults,\n          email_campaign: {\n              subscribers_reached: emailsSent,\n              errors: emailErrors.length,\n              campaign_id: campaign.id\n          },\n          message: `[R] CAMPAGNE TOTALE DEPLOYE ! ${emailsSent} emails + ${tweetResults.length} tweets generes.`\n      });\n\n  } catch (error) {\n      console.error(\"Erreur Campagne Marketing Totale:\", error);\n      return Response.json({ error: `Erreur du Maestro: ${error.message}` }, { status: 500 });\n  }\n});